<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管理端</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding: 16px;
      margin: 0;
      background-color: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 24px;
      color: #495057;
    }
    h2 {
      font-size: 1.2rem;
      margin-bottom: 12px;
      color: #6c757d;
    }
    input[type="file"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 1rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .stats-container {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #dee2e6;
    }
    .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .stat-label {
        font-weight: bold;
    }
    .stat-value {
        color: #495057;
    }
    #clearAllStatusBtn {
        background-color: #dc3545; /* Red */
    }
    #clearAllStatusBtn:hover {
        background-color: #c82333;
    }
    .loading {
        color: #888;
    }
    .message {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
    }
    .message.success {
        background-color: #d4edda;
        color: #155724;
    }
    .message.error {
        background-color: #f8d7da;
        color: #721c24;
    }
    /* 新增：详细统计样式 */
    .detailed-stats-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 6px;
        border-left: 4px solid #007bff;
    }
    .detailed-stats-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: #495057;
    }
    .detailed-stat-item {
        margin-bottom: 8px;
    }
    .detailed-stat-type {
        font-weight: bold;
        color: #6c757d;
    }
    .detailed-stat-accounts {
        font-size: 0.9rem;
        color: #555;
        word-break: break-all; /* 防止长账号导致布局错乱 */
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>设备信息管理系统 - 管理端</h1>

    <div>
      <h2>导入CSV数据</h2>
      <input type="file" id="csvFile" accept=".csv" />
      <button onclick="importCSV()">上传CSV</button>
      <div id="importMessage"></div>
    </div>

    <div class="stats-container">
        <h2>今日统计</h2>
        <div id="stats">
            <div class="loading">加载统计信息...</div>
        </div>
        <button id="clearAllStatusBtn" onclick="confirmClearAllStatus()">清除所有状态</button>
        <div id="clearMessage"></div>

        <!-- 新增：详细统计展示区域 -->
        <div id="detailedStatsSection" class="detailed-stats-container" style="display:none;">
            <div class="detailed-stats-title">详细异常统计</div>
            <div id="detailedStatsContent"></div>
        </div>
    </div>

  </div>

  <script>
    async function importCSV() {
        const fileInput = document.getElementById('csvFile');
        const messageDiv = document.getElementById('importMessage');

        if (!fileInput.files.length) {
            messageDiv.innerHTML = '<div class="message error">请选择一个CSV文件</div>';
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('http://47.122.79.126:5233/api/import_csv', {
                method: 'POST',
                body: formData, // 注意：使用FormData时，不要设置Content-Type，浏览器会自动设置
            });

            const data = await response.json();
            if (response.ok) {
                messageDiv.innerHTML = `<div class="message success">${data.message}</div>`;
                loadStats(); // 导入成功后刷新统计
                loadDetailedStats(); // 同时刷新详细统计
            } else {
                messageDiv.innerHTML = `<div class="message error">${data.error}</div>`;
            }
        } catch (err) {
            console.error('Import error:', err);
            messageDiv.innerHTML = '<div class="message error">网络错误，导入失败</div>';
        }
    }

    async function loadStats() {
        try {
            const response = await fetch('http://47.122.79.126:5233/api/stats');
            const data = await response.json();
            if (response.ok) {
                const statsHtml = `
                    <div class="stat-item">
                        <span class="stat-label">今日异常:</span>
                        <span class="stat-value">${data.today_error_count}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">今日未完成:</span>
                        <span class="stat-value">${data.today_uncompleted_count}</span>
                    </div>
                `;
                document.getElementById('stats').innerHTML = statsHtml;
            } else {
                document.getElementById('stats').innerHTML = `<div class="message error">加载统计失败: ${data.error}</div>`;
            }
        } catch (err) {
            console.error('Load stats error:', err);
            document.getElementById('stats').innerHTML = '<div class="message error">网络错误，加载统计失败</div>';
        }
    }

    // --- 新增函数：加载详细统计 ---
    async function loadDetailedStats() {
        try {
            const response = await fetch('http://47.122.79.126:5233/api/detailed_stats');
            const data = await response.json();
            if (response.ok) {
                const detailedContentDiv = document.getElementById('detailedStatsContent');
                let detailedHtml = `<div class="detailed-stat-item"><strong>总计异常: ${data.total_error_count}</strong></div>`;
                
                // 显示各类异常
                for (const [status, count] of Object.entries(data.error_types)) {
                    const accounts = data.error_details[status];
                    detailedHtml += `
                        <div class="detailed-stat-item">
                            <span class="detailed-stat-type">${status} (${count}个):</span>
                            <div class="detailed-stat-accounts">${accounts.join(', ')}</div>
                        </div>
                    `;
                }

                // 显示未完成
                if (data.uncompleted_count > 0) {
                    detailedHtml += `
                        <div class="detailed-stat-item">
                            <span class="detailed-stat-type">未完成 (${data.uncompleted_count}个):</span>
                            <div class="detailed-stat-accounts">${data.uncompleted_details.join(', ')}</div>
                        </div>
                    `;
                }

                detailedContentDiv.innerHTML = detailedHtml;
                document.getElementById('detailedStatsSection').style.display = 'block'; // 显示区域
            } else {
                document.getElementById('detailedStatsContent').innerHTML = `<div class="message error">加载详细统计失败: ${data.error}</div>`;
                document.getElementById('detailedStatsSection').style.display = 'block'; // 确保区域显示
            }
        } catch (err) {
            console.error('Load detailed stats error:', err);
            document.getElementById('detailedStatsContent').innerHTML = '<div class="message error">网络错误，加载详细统计失败</div>';
            document.getElementById('detailedStatsSection').style.display = 'block'; // 确保区域显示
        }
    }

    function confirmClearAllStatus() {
        const confirmation = prompt("⚠️ 危险操作！\n此操作将清除所有记录的状态。\n请输入 '确认清除' 以继续：");
        if (confirmation === "确认清除") {
            sendClearAllStatusRequest();
        } else {
            document.getElementById('clearMessage').innerHTML = '<div class="message error">操作已取消</div>';
        }
    }

    async function sendClearAllStatusRequest() {
        const messageDiv = document.getElementById('clearMessage');
        try {
            const response = await fetch('http://47.122.79.126:5233/api/clear_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confirmation: "确认清除" })
            });

            const data = await response.json();
            if (response.ok) {
                messageDiv.innerHTML = `<div class="message success">${data.message}</div>`;
                loadStats(); // 清除成功后刷新统计
                loadDetailedStats(); // 同时刷新详细统计
            } else {
                messageDiv.innerHTML = `<div class="message error">${data.error}</div>`;
            }
        } catch (err) {
            console.error('Clear status error:', err);
            messageDiv.innerHTML = '<div class="message error">网络错误，清除失败</div>';
        }
    }

    // 页面加载时获取统计信息
    window.onload = () => {
        loadStats();
        loadDetailedStats(); // 加载详细统计
    };

  </script>
</body>
</html>
